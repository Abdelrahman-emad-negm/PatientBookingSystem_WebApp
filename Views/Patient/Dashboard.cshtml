@model List<PatientBooking.Models.Appointment>
@{
    ViewData["Title"] = "Patient Dashboard";
    Layout = "~/Views/Shared/_Layout.cshtml";
    var patientName = ViewBag.PatientName as string ?? "Patient";

    var qDoctor = Context.Request.Query["doctorName"].ToString();
    var qSpecialty = Context.Request.Query["specialty"].ToString();
    var qDate = Context.Request.Query["date"].ToString();
}

<div class="container py-4">
    <!-- Welcome Header -->
    <div class="welcome-card card border-0 shadow mb-4 overflow-hidden">
        <div class="card-body p-0">
            <div class="row g-0">
                <div class="col-md-8 p-4 d-flex flex-column">
                    <h2 class="text-primary mb-3">Welcome back, @patientName!</h2>
                    <p class="lead mb-4">Find and book appointments with our specialists</p>
                    <div class="d-flex gap-2 mt-auto">
                        <a href="/Patient/MyAppointments" class="btn btn-primary">
                            <i class="fas fa-calendar-check me-2"></i>My Appointments
                        </a>
                        <a href="#available-appointments" class="btn btn-outline-primary">
                            <i class="fas fa-search me-2"></i>Browse Doctors
                        </a>
                    </div>
                </div>
                <div class="col-md-4 d-none d-md-block">
                    <div class="h-100 bg-primary-light" style="background: url('https://img.freepik.com/free-vector/medical-team-concept-illustration_114360-840.jpg') center/cover;"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Search Section -->
    <div class="card shadow-sm mb-4" id="search-section">
        <div class="card-header bg-white">
            <h5 class="mb-0"><i class="fas fa-search me-2 text-primary"></i> Find Appointments</h5>
        </div>
        <div class="card-body">
            <form method="get" asp-action="Dashboard" class="row g-3">
                <div class="col-md-4">
                    <div class="input-group">
                        <span class="input-group-text bg-light"><i class="fas fa-user-md text-primary"></i></span>
                        <input type="text" name="doctorName" class="form-control" placeholder="Doctor name" value="@qDoctor" />
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="input-group">
                        <span class="input-group-text bg-light"><i class="fas fa-stethoscope text-primary"></i></span>
                        <input type="text" name="specialty" class="form-control" placeholder="Specialty" value="@qSpecialty" />
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="input-group">
                        <span class="input-group-text bg-light"><i class="fas fa-calendar-day text-primary"></i></span>
                        <input type="date" name="date" class="form-control" value="@qDate" />
                    </div>
                </div>
                <div class="col-md-1 d-grid">
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-search"></i>
                    </button>
                </div>
            </form>
        </div>
    </div>

    @if (!string.IsNullOrEmpty(qDoctor) || !string.IsNullOrEmpty(qSpecialty) || !string.IsNullOrEmpty(qDate))
    {
        <div class="alert alert-info alert-dismissible fade show mb-4">
            <i class="fas fa-info-circle me-2"></i>
            Showing filtered results for your search criteria.
            <a href="/Patient/Dashboard" class="alert-link ms-2">Clear filters</a>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }

    <!-- Available Appointments -->
    <div class="card shadow-sm mb-4" id="available-appointments">
        <div class="card-header bg-white d-flex justify-content-between align-items-center">
            <h5 class="mb-0">
                <i class="fas fa-calendar-alt me-2 text-primary"></i> Available Appointments
            </h5>
            <span class="badge bg-primary rounded-pill">@Model.Count() available</span>
        </div>
        <div class="card-body">
            @if (!Model.Any())
            {
                <div class="empty-state text-center py-5">
                    <i class="fas fa-calendar-times fa-4x text-muted mb-4"></i>
                    <h4 class="text-muted mb-3">No appointments available</h4>
                    <p class="text-muted mb-4">Try adjusting your search criteria or check back later</p>
                    <a href="/Patient/Dashboard" class="btn btn-primary">
                        <i class="fas fa-sync-alt me-2"></i>Reset Search
                    </a>
                </div>
            }
            else
            {
                <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4">
                    @foreach (var item in Model)
                    {
                        var doctorName = item.Doctor?.User?.Name ?? "Doctor";
                        var specialtyName = item.Doctor != null ? item.Doctor.Specialty.ToString() : "General";

                        <div class="col">
                            <div class="doctor-card card h-100 border-0 shadow-sm">
                                <div class="doctor-image-container">
                                    @if (!string.IsNullOrEmpty(item.Doctor?.Photo))
                                    {
                                        <img src="@item.Doctor.Photo" class="doctor-image" alt="@doctorName">
                                    }
                                    else
                                    {
                                        <div class="default-doctor-avatar">
                                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                                                <path d="M8 9a3 3 0 100-6 3 3 0 000 6zM8 11a6 6 0 016 6H2a6 6 0 016-6z" />
                                            </svg>
                                            <span>Dr. @doctorName</span>
                                        </div>
                                    }
                                    <div class="doctor-specialty-badge">@specialtyName</div>
                                </div>
                                <div class="card-body">
                                    <h5 class="card-title mb-3">Dr. @doctorName</h5>

                                    <div class="appointment-time mb-3 p-3 bg-light rounded">
                                        <div class="d-flex justify-content-between">
                                            <span class="fw-bold"><i class="fas fa-calendar-day me-1"></i> @item.Date.ToString("dd MMM yyyy")</span>
                                            <span class="fw-bold"><i class="fas fa-clock me-1"></i> @item.TimeSlot.ToString(@"hh\:mm")</span>
                                        </div>
                                    </div>

                                    <form asp-action="Book" method="post" class="mt-auto">
                                        <input type="hidden" name="id" value="@item.AppointmentId" />
                                        <button type="submit" class="btn btn-primary w-100"
                                                onclick="return confirm('Book appointment with Dr. @doctorName on @item.Date.ToString("dd MMM") at @item.TimeSlot.ToString(@"hh\:mm")?')">
                                            <i class="fas fa-calendar-plus me-2"></i>Book Appointment
                                        </button>
                                    </form>
                                </div>
                            </div>
                        </div>
                    }
                </div>
            }
        </div>
    </div>
</div>

<style>
    .welcome-card {
        border-radius: 12px;
        overflow: hidden;
    }

    .primary-light {
        background-color: rgba(13, 110, 253, 0.1);
    }

    .doctor-card {
        transition: all 0.3s ease;
        border-radius: 10px;
        overflow: hidden;
    }

        .doctor-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }

    .doctor-image-container {
        position: relative;
        height: 180px;
        overflow: hidden;
    }

    .doctor-image {
        width: 100%;
        height: 100%;
        object-fit: cover;
        transition: transform 0.3s ease;
    }

    .doctor-card:hover .doctor-image {
        transform: scale(1.05);
    }

    .doctor-specialty-badge {
        position: absolute;
        bottom: 15px;
        left: 15px;
        background: rgba(13, 110, 253, 0.9);
        color: white;
        padding: 5px 10px;
        border-radius: 20px;
        font-size: 0.8rem;
        font-weight: 500;
    }

    .empty-state {
        max-width: 500px;
        margin: 0 auto;
    }

    .default-doctor-avatar {
        width: 100%;
        height: 100%;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        background-color: #f0f8ff;
        color: #4682b4;
    }

        .default-doctor-avatar svg {
            width: 80px;
            height: 80px;
            margin-bottom: 10px;
        }

        .default-doctor-avatar span {
            font-weight: 500;
            text-align: center;
            padding: 0 10px;
        }
</style>

@section Scripts {
    <script>
        // Smooth scroll to appointments section
        document.querySelectorAll('a[href^="#"]').forEach(anchor => {
            anchor.addEventListener('click', function (e) {
                e.preventDefault();
                document.querySelector(this.getAttribute('href')).scrollIntoView({
                    behavior: 'smooth'
                });
            });
        });
    </script>
}
